{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}پرداخت - {{ site_settings.site_name|default:"داروخانه دکتر واعظی" }}{% endblock %}

{% block content %}
<main class="flex-1 pb-20 lg:pb-0">
  <div class="container mx-auto w-full">
    <!-- Breadcrumb -->
    <nav class="my-4 flex px-4 lg:px-0">
      <ol class="inline-flex items-center space-x-1 md:space-x-2">
        <li class="group flex items-center">
          <a href="{% url 'core:home' %}" class="group-hover:text-primary-600 inline-flex items-center text-sm font-medium text-gray-800 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M12.707 2.293l9 9c.63 .63 .184 1.707 -.707 1.707h-1v6a3 3 0 0 1 -3 3h-1v-7a3 3 0 0 0 -2.824 -2.995l-.176 -.005h-2a3 3 0 0 0 -3 3v7h-1a3 3 0 0 1 -3 -3v-6h-1c-.89 0 -1.337 -1.077 -.707 -1.707l9 -9a1 1 0 0 1 1.414 0m.293 11.707a1 1 0 0 1 1 1v7h-4v-7a1 1 0 0 1 .883 -.993l.117 -.007z" />
            </svg>
            <span class="ms-1 text-sm font-medium text-gray-700 md:ms-2">خانه</span>
          </a>
        </li>
        <li>
          <div class="flex items-center">
            <svg class="mx-1 h-3 w-3 text-gray-400 rtl:rotate-180" fill="none" viewBox="0 0 6 10">
              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"></path>
            </svg>
            <span class="ms-1 text-sm font-medium text-gray-700">پرداخت</span>
          </div>
        </li>
      </ol>
    </nav>

    <!-- Stepper -->
    <div class="my-6 w-full px-4 lg:px-0">
      <ol class="relative flex items-center justify-between max-w-xl mx-auto">
        <!-- Step 1 - سبد خرید -->
        <li class="relative flex w-full flex-col items-center text-center">
          <div class="border-green-500 bg-green-50 text-green-600 z-10 flex h-10 w-10 items-center justify-center rounded-full border-2 font-semibold">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M5 12l5 5l10 -10" />
            </svg>
          </div>
          <p class="text-green-600 font-yekan-bakh mt-2 text-sm">سبد خرید</p>
        </li>

        <!-- Step 2 - شیوه ارسال -->
        <li class="relative flex w-full flex-col items-center text-center">
          <div class="border-green-500 bg-green-50 text-green-600 z-10 flex h-10 w-10 items-center justify-center rounded-full border-2 font-semibold">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M5 12l5 5l10 -10" />
            </svg>
          </div>
          <p class="text-green-600 font-yekan-bakh mt-2 text-sm">شیوه ارسال</p>
        </li>

        <!-- Step 3 - پرداخت -->
        <li class="relative flex w-full flex-col items-center text-center">
          <div class="border-primary-200 bg-primary-50 text-primary-800 z-10 flex h-10 w-10 items-center justify-center rounded-full border-2 font-semibold">
            3
          </div>
          <p class="text-primary-800 font-yekan-bakh mt-2 text-sm">پرداخت</p>
        </li>
      </ol>
    </div>

    <section class="my-10 flex flex-col justify-between gap-6 px-4 lg:flex-row lg:px-0">
      <!-- Main Content -->
      <div class="flex w-full flex-col gap-y-6 lg:w-3/4">
        <!-- اطلاعات سفارش -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
          <div class="p-4 border-b border-gray-100">
            <h2 class="font-bold text-gray-800">اطلاعات سفارش</h2>
          </div>
          
          <div class="p-4">
            <!-- آدرس -->
            <div class="flex items-start gap-3 mb-4 pb-4 border-b border-gray-100">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-primary-600 shrink-0">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 11a3 3 0 1 0 6 0a3 3 0 0 0 -6 0" /><path d="M17.657 16.657l-4.243 4.243a2 2 0 0 1 -2.827 0l-4.244 -4.243a8 8 0 1 1 11.314 0z" />
              </svg>
              <div>
                <p class="font-semibold text-gray-800 mb-1">آدرس تحویل</p>
                <p class="text-sm text-gray-600">{{ order.address.province }} - {{ order.address.city }}</p>
                <p class="text-sm text-gray-600">{{ order.address.full_address }}</p>
                <p class="text-sm text-gray-500 mt-1">گیرنده: {{ order.address.receiver_name }} - {{ order.address.receiver_phone }}</p>
              </div>
            </div>
            
            <!-- شیوه ارسال -->
            <div class="flex items-center gap-3">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-primary-600 shrink-0">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" /><path d="M17 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" /><path d="M5 17h-2v-11a1 1 0 0 1 1 -1h9v12m-4 0h6m4 0h2v-6h-8m0 -5h5l3 5" />
              </svg>
              <div>
                <p class="font-semibold text-gray-800">شیوه ارسال: {{ order.get_shipping_method_display }}</p>
                <p class="text-sm text-gray-500">تحویل ۲ تا ۴ روز کاری</p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- محصولات -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
          <div class="p-4 border-b border-gray-100">
            <h2 class="font-bold text-gray-800">کالاهای سفارش ({{ order.items.count }} کالا)</h2>
          </div>
          
          <div class="divide-y divide-gray-100">
            {% for item in order.items.all %}
            <div class="p-4 flex items-center gap-4">
              <div class="w-16 h-16 rounded-lg overflow-hidden bg-gray-100 shrink-0">
                {% if item.product.images.first %}
                <img src="{{ item.product.images.first.image.url }}" alt="{{ item.product.name }}" class="w-full h-full object-cover">
                {% else %}
                <img src="{% static 'images/product/placeholder.jpg' %}" alt="{{ item.product.name }}" class="w-full h-full object-cover">
                {% endif %}
              </div>
              <div class="flex-1 min-w-0">
                <h3 class="font-semibold text-gray-800 text-sm truncate">{{ item.product.name }}</h3>
                <p class="text-sm text-gray-500">تعداد: {{ item.quantity }}</p>
              </div>
              <div class="text-left">
                <p class="font-semibold text-gray-800">{{ item.total_price|intcomma }} تومان</p>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        
        <!-- روش پرداخت -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
          <div class="p-4 border-b border-gray-100">
            <h2 class="font-bold text-gray-800">روش پرداخت</h2>
          </div>
          
          <div class="p-4 space-y-4">
            <label class="flex items-center gap-4 p-4 border border-primary-500 bg-primary-50 rounded-lg cursor-pointer">
              <input type="radio" name="payment_method" value="zarinpal" checked
                     class="text-primary-600 focus:ring-primary-500">
              <div class="flex-1">
                <div class="flex items-center gap-2">
                  <img src="{% static 'images/zarinpal.png' %}" alt="زرین پال" class="h-6">
                  <span class="font-semibold text-gray-800">درگاه پرداخت زرین‌پال</span>
                </div>
                <p class="text-sm text-gray-500 mt-1">پرداخت آنلاین با تمام کارت‌های بانکی</p>
              </div>
            </label>
          </div>
        </div>
      </div>

      <!-- Price Box -->
      <div class="w-full lg:w-1/4">
        <div class="sticky top-4 bg-white rounded-xl shadow-md p-4">
          <h3 class="font-bold text-gray-800 mb-4">خلاصه پرداخت</h3>
          
          <div class="space-y-3 mb-4 pb-4 border-b border-gray-100">
            <div class="flex items-center justify-between">
              <span class="text-gray-600">قیمت کالاها</span>
              <span class="font-semibold text-gray-800">{{ order.subtotal|intcomma }} تومان</span>
            </div>
            {% if order.discount_amount %}
            <div class="flex items-center justify-between">
              <span class="text-gray-600">تخفیف</span>
              <span class="font-semibold text-green-600">{{ order.discount_amount|intcomma }} تومان</span>
            </div>
            {% endif %}
            <div class="flex items-center justify-between">
              <span class="text-gray-600">هزینه ارسال</span>
              <span class="font-semibold text-gray-800">{{ order.shipping_cost|intcomma }} تومان</span>
            </div>
          </div>
          
          <div class="flex items-center justify-between mb-6">
            <span class="font-bold text-gray-800">مبلغ قابل پرداخت</span>
            <span class="font-bold text-primary-800 text-xl">{{ order.total_price|intcomma }} تومان</span>
          </div>
          
          <form action="{% url 'orders:payment' order.id %}" method="POST">
            {% csrf_token %}
            <button type="submit" 
                    class="w-full bg-gradient-to-r from-primary-800 to-pink-300 text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity flex items-center justify-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 5m0 3a3 3 0 0 1 3 -3h12a3 3 0 0 1 3 3v8a3 3 0 0 1 -3 3h-12a3 3 0 0 1 -3 -3z" /><path d="M3 10l18 0" /><path d="M7 15l.01 0" /><path d="M11 15l2 0" />
              </svg>
              پرداخت
            </button>
          </form>
          
          <a href="{% url 'orders:checkout_shipping' %}" class="block text-center mt-4 text-sm text-gray-500 hover:text-primary-600">
            بازگشت به مرحله قبل
          </a>
        </div>
      </div>
    </section>
  </div>
</main>
{% endblock %}
