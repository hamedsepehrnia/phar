{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ product.name }} - {{ site_settings.site_name|default:"داروخانه دکتر واعظی" }}{% endblock %}

{% block meta_description %}{{ product.description|striptags|truncatewords:25 }}{% endblock %}
{% block meta_keywords %}{{ product.name }}, {{ product.brand.name }}, {{ product.category.name }}, خرید دارو{% endblock %}
{% block og_title %}{{ product.name }}{% endblock %}
{% block og_description %}{{ product.description|striptags|truncatewords:25 }}{% endblock %}
{% block og_image %}{{ request.scheme }}://{{ request.get_host }}{{ product.image.url }}{% endblock %}
{% block og_type %}product{% endblock %}

{% block extra_structured_data %}{% include 'catalog/product_detail_seo.html' %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" crossorigin href="{% static 'css/main2.css' %}">
{% endblock %}

{% block content %}
<main class="flex-1 pb-20 lg:pb-0">
  <div class="container mx-auto px-4 py-6">
    <!-- Breadcrumb -->
    <nav class="mb-6">
      <ol class="flex items-center gap-2 text-sm text-gray-500 flex-wrap">
        <li><a href="{% url 'core:home' %}" class="hover:text-primary-800">خانه</a></li>
        <li>/</li>
        <li><a href="{% url 'catalog:shop' %}" class="hover:text-primary-800">فروشگاه</a></li>
        {% if product.category %}
        <li>/</li>
        <li><a href="{% url 'catalog:shop' %}?category={{ product.category.slug }}" class="hover:text-primary-800">{{ product.category.name }}</a></li>
        {% endif %}
        <li>/</li>
        <li class="text-gray-800 font-semibold truncate max-w-xs">{{ product.name }}</li>
      </ol>
    </nav>

    <div class="flex flex-col lg:flex-row gap-8">
      <!-- گالری تصاویر -->
      <div class="w-full lg:w-2/5">
        <div class="bg-white rounded-2xl p-4 shadow-sm sticky top-4" x-data="{ activeImage: 0 }">
          <!-- تصویر اصلی -->
          <div class="relative mb-4 rounded-xl overflow-hidden bg-gray-50" style="max-height: 350px;">
            {% for image in product.images.all %}
            <img src="{{ image.image.url }}" alt="{{ product.name }}"
                 x-show="activeImage === {{ forloop.counter0 }}"
                 class="w-full h-full object-contain" style="max-height: 350px;" />
            {% empty %}
            <img src="{% static 'images/product/placeholder.jpg' %}" alt="{{ product.name }}"
                 class="w-full h-full object-contain" style="max-height: 350px;" />
            {% endfor %}
          </div>
          
          <!-- تصاویر کوچک -->
          {% if product.images.count > 1 %}
          <div class="flex gap-2 overflow-x-auto justify-center py-2">
            {% for image in product.images.all %}
            <button @click="activeImage = {{ forloop.counter0 }}"
                    :class="activeImage === {{ forloop.counter0 }} ? 'ring-2 ring-primary-600' : 'ring-1 ring-gray-200'"
                    class="shrink-0 w-16 h-16 rounded-lg overflow-hidden transition-all hover:ring-2 hover:ring-primary-400">
              <img src="{{ image.image.url }}" alt="{{ product.name }}" class="w-full h-full object-cover" />
            </button>
            {% endfor %}
          </div>
          {% endif %}
        </div>
      </div>

      <!-- اطلاعات محصول -->
      <div class="w-full lg:w-3/5">
        <div class="bg-white rounded-2xl p-6 shadow-sm">
          <!-- نام محصول -->
          <h1 class="text-xl lg:text-2xl font-bold text-gray-800 mb-4">{{ product.name }}</h1>

          <!-- امتیاز و نظرات -->
          <div class="flex items-center gap-4 mb-4">
            <div class="flex items-center gap-1">
              {% for i in "12345" %}
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" 
                   fill="{% if forloop.counter <= product.average_rating|default:0 %}currentColor{% else %}none{% endif %}"
                   stroke="currentColor" stroke-width="2"
                   class="{% if forloop.counter <= product.average_rating|default:0 %}text-yellow-400{% else %}text-gray-300{% endif %}">
                <path d="M12 17.75l-6.172 3.245l1.179 -6.873l-5 -4.867l6.9 -1l3.086 -6.253l3.086 6.253l6.9 1l-5 4.867l1.179 6.873z" />
              </svg>
              {% endfor %}
              <span class="text-sm text-gray-600 mr-2">{{ product.average_rating|default:"0"|floatformat:1 }}</span>
            </div>
            <span class="text-sm text-gray-500">({{ product.reviews_count|default:0 }} نظر)</span>
          </div>

          <!-- برند -->
          {% if product.brand %}
          <div class="flex items-center gap-2 mb-4">
            <span class="text-sm text-gray-600">برند:</span>
            <a href="{% url 'catalog:shop' %}?brand={{ product.brand.slug }}" class="text-sm text-primary-800 hover:underline">{{ product.brand.name }}</a>
          </div>
          {% endif %}

          <!-- قیمت -->
          <div class="flex items-center gap-4 mb-6">
            {% if product.compare_at_price and product.compare_at_price > product.price %}
            <span class="text-lg text-gray-400 line-through">{{ product.compare_at_price|intcomma }} تومان</span>
            <span class="bg-red-100 text-red-600 text-sm font-semibold px-2 py-1 rounded">
              {{ product.discount_percent }}% تخفیف
            </span>
            {% endif %}
          </div>
          <div class="text-2xl font-bold text-primary-800 mb-6">
            {{ product.price|intcomma }} تومان
          </div>

          <!-- وضعیت موجودی -->
          <div class="flex items-center gap-2 mb-6">
            {% if product.is_in_stock %}
            <span class="flex items-center gap-1 text-green-600">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2">
                <path d="M5 12l5 5l10 -10" />
              </svg>
              موجود در انبار
            </span>
            {% if product.stock_quantity <= 5 %}
            <span class="text-sm text-orange-600">(فقط {{ product.stock_quantity }} عدد باقی مانده)</span>
            {% endif %}
            {% else %}
            <span class="flex items-center gap-1 text-red-600">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2">
                <path d="M18 6l-12 12" />
                <path d="M6 6l12 12" />
              </svg>
              ناموجود
            </span>
            {% endif %}
          </div>

          <!-- دکمه افزودن به سبد خرید -->
          {% if product.is_in_stock %}
          <form action="{% url 'cart:add' product.id %}" method="POST" class="mb-6" x-data="{ quantity: 1 }">
            {% csrf_token %}
            <div class="flex items-center gap-4">
              <!-- انتخاب تعداد -->
              <div class="flex items-center border border-gray-300 rounded-lg">
                <button type="button" @click="quantity = Math.max(1, quantity - 1)" 
                        class="w-10 h-10 flex items-center justify-center text-gray-600 hover:bg-gray-100">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2">
                    <path d="M5 12h14" />
                  </svg>
                </button>
                <input type="number" name="quantity" x-model="quantity" min="1" max="{{ product.stock_quantity }}"
                       class="w-14 h-10 text-center border-x border-gray-300 focus:outline-none" />
                <button type="button" @click="quantity = Math.min({{ product.stock_quantity }}, quantity + 1)"
                        class="w-10 h-10 flex items-center justify-center text-gray-600 hover:bg-gray-100">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14" />
                    <path d="M5 12h14" />
                  </svg>
                </button>
              </div>
              
              <!-- دکمه افزودن -->
              <button type="submit" 
                      class="flex-1 bg-primary-600 hover:bg-primary-700 text-white py-3 px-6 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2">
                  <path d="M4 19a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
                  <path d="M12.5 17h-6.5v-14h-2" />
                  <path d="M6 5l14 1l-.86 6.017m-2.64 .983h-10.5" />
                  <path d="M16 19h6" />
                  <path d="M19 16v6" />
                </svg>
                افزودن به سبد خرید
              </button>
            </div>
          </form>
          {% endif %}

          <!-- دکمه علاقه‌مندی -->
          {% if user.is_authenticated %}
          <form action="{% url 'catalog:wishlist_toggle' product.id %}" method="POST" class="mb-6">
            {% csrf_token %}
            <button type="submit" 
                    class="w-full border border-gray-300 hover:border-primary-600 text-gray-700 hover:text-primary-600 py-3 px-6 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" 
                   fill="{% if is_in_wishlist %}currentColor{% else %}none{% endif %}"
                   stroke="currentColor" stroke-width="2"
                   class="{% if is_in_wishlist %}text-red-500{% endif %}">
                <path d="M19.5 12.572l-7.5 7.428l-7.5 -7.428a5 5 0 1 1 7.5 -6.566a5 5 0 1 1 7.5 6.572" />
              </svg>
              {% if is_in_wishlist %}
              حذف از علاقه‌مندی‌ها
              {% else %}
              افزودن به علاقه‌مندی‌ها
              {% endif %}
            </button>
          </form>
          {% else %}
          <a href="{% url 'accounts:login' %}?next={{ request.path }}" 
             class="mb-6 w-full border border-gray-300 hover:border-primary-600 text-gray-700 hover:text-primary-600 py-3 px-6 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" 
                 fill="none"
                 stroke="currentColor" stroke-width="2">
              <path d="M19.5 12.572l-7.5 7.428l-7.5 -7.428a5 5 0 1 1 7.5 -6.566a5 5 0 1 1 7.5 6.572" />
            </svg>
            برای افزودن به علاقه‌مندی‌ها وارد شوید
          </a>
          {% endif %}

          <!-- ویژگی‌های محصول -->
          {% if product.features.exists %}
          <div class="border-t border-gray-200 pt-6">
            <h3 class="font-semibold text-gray-800 mb-4">ویژگی‌های محصول</h3>
            <ul class="space-y-2">
              {% for feature in product.features.all %}
              <li class="flex items-center gap-2 text-sm">
                <span class="text-gray-600">{{ feature.name }}:</span>
                <span class="text-gray-800 font-semibold">{{ feature.value }}</span>
              </li>
              {% endfor %}
            </ul>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- توضیحات محصول -->
    <div class="mt-8 bg-white rounded-2xl p-6 shadow-sm">
      <h2 class="text-xl font-bold text-gray-800 mb-4">توضیحات محصول</h2>
      <div class="prose prose-sm max-w-none text-gray-600">
        {{ product.description|safe|default:"توضیحاتی برای این محصول ثبت نشده است." }}
      </div>
    </div>

    <!-- نظرات -->
    <div class="mt-8 bg-white rounded-2xl p-6 shadow-sm">
      <h2 class="text-xl font-bold text-gray-800 mb-4">نظرات کاربران ({{ reviews.count }})</h2>
      
      {% if user.is_authenticated %}
      <form action="{% url 'reviews:add' product.id %}" method="POST" class="mb-6 p-4 bg-gray-50 rounded-lg">
        {% csrf_token %}
        <div class="mb-4">
          <label class="block text-sm font-semibold text-gray-700 mb-2">امتیاز شما</label>
          <div class="flex items-center gap-1" x-data="{ rating: 5 }">
            {% for i in "12345" %}
            <button type="button" @click="rating = {{ forloop.counter }}"
                    :class="rating >= {{ forloop.counter }} ? 'text-yellow-400' : 'text-gray-300'">
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 17.75l-6.172 3.245l1.179 -6.873l-5 -4.867l6.9 -1l3.086 -6.253l3.086 6.253l6.9 1l-5 4.867l1.179 6.873z" />
              </svg>
            </button>
            {% endfor %}
            <input type="hidden" name="rating" x-model="rating">
          </div>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-semibold text-gray-700 mb-2">نظر شما</label>
          <textarea name="content" rows="4" required
                    class="w-full p-3 border border-gray-300 rounded-lg focus:border-primary-600 focus:ring-1 focus:ring-primary-600"
                    placeholder="نظر خود را بنویسید..."></textarea>
        </div>
        <button type="submit" class="bg-primary-600 hover:bg-primary-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors">
          ثبت نظر
        </button>
      </form>
      {% else %}
      <p class="text-sm text-gray-500 mb-6">
        برای ثبت نظر <a href="{% url 'accounts:login' %}" class="text-primary-600 hover:underline">وارد شوید</a>
      </p>
      {% endif %}

      <!-- لیست نظرات -->
      <div class="space-y-4">
        {% for review in reviews %}
        <div class="border-b border-gray-100 pb-4 last:border-0">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <span class="font-semibold text-gray-800">{{ review.user.get_full_name|default:review.user.phone }}</span>
              <div class="flex items-center gap-0.5">
                {% for i in "12345" %}
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" 
                     fill="{% if forloop.counter <= review.rating %}currentColor{% else %}none{% endif %}"
                     stroke="currentColor" stroke-width="2"
                     class="{% if forloop.counter <= review.rating %}text-yellow-400{% else %}text-gray-300{% endif %}">
                  <path d="M12 17.75l-6.172 3.245l1.179 -6.873l-5 -4.867l6.9 -1l3.086 -6.253l3.086 6.253l6.9 1l-5 4.867l1.179 6.873z" />
                </svg>
                {% endfor %}
              </div>
            </div>
            <span class="text-xs text-gray-400">{{ review.created_at|date:"Y/m/d" }}</span>
          </div>
          <p class="text-sm text-gray-600">{{ review.content }}</p>
        </div>
        {% empty %}
        <p class="text-sm text-gray-500 text-center py-8">هنوز نظری ثبت نشده است. اولین نفری باشید که نظر می‌دهد!</p>
        {% endfor %}
      </div>
    </div>

    <!-- محصولات مرتبط -->
    {% if related_products %}
    <div class="mt-8">
      <h2 class="text-xl font-bold text-gray-800 mb-4">محصولات مرتبط</h2>
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4">
        {% for product in related_products %}
        {% include 'partials/card_product.html' with product=product %}
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>
</main>
{% endblock %}
