{% load static %}
{% load humanize %}
<div class="group relative w-full rounded-lg bg-white p-4 pt-8 shadow-md" style="border: none !important; outline: none !important;">
  <!-- Product Colors - اگر تنوع رنگ دارد -->
  {% if product.variants.exists %}
  <div class="absolute top-5 left-4 flex flex-col space-y-2">
    {% for variant in product.variants.all|slice:":3" %}
    <span class="h-4 w-4 rounded-full" style="background-color: {{ variant.color_code|default:'#ccc' }};"></span>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Product Image-->
  <a href="{{ product.get_absolute_url }}">
    {% if product.images.exists %}
    <img src="{{ product.images.first.image.url }}" alt="{{ product.name }}"
      loading="{% if forloop.counter <= 6 %}eager{% else %}lazy{% endif %}"
      decoding="async"
      class="mb-4 h-40 w-full rounded-md object-contain" />
    {% else %}
    <img src="{% static 'images/product/placeholder.jpg' %}" alt="{{ product.name }}"
      loading="lazy"
      decoding="async"
      class="mb-4 h-40 w-full rounded-md object-contain" />
    {% endif %}
  </a>

  <!-- Action Icons -->
  <div class="absolute top-4 right-4 flex flex-col space-y-2 text-gray-600">
    <!-- Icon: Quick View -->
    <a href="{{ product.get_absolute_url }}" class="cursor-pointer transition-colors hover:text-gray-800">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        class="icon icon-tabler icons-tabler-outline icon-tabler-eye">
        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
        <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
        <path d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6" />
      </svg>
    </a>
    
    <!-- Icon: Add to Wishlist -->
    {% if user.is_authenticated %}
    <form action="{% url 'catalog:wishlist_toggle' product.id %}" method="POST" class="inline">
      {% csrf_token %}
      <button type="submit" class="cursor-pointer transition-colors hover:text-red-500 {% if product.id in wishlist_ids %}text-red-500{% endif %}">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" 
          fill="{% if product.id in wishlist_ids %}currentColor{% else %}none{% endif %}"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
          class="icon icon-tabler icons-tabler-outline icon-tabler-heart">
          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
          <path d="M19.5 12.572l-7.5 7.428l-7.5 -7.428a5 5 0 1 1 7.5 -6.566a5 5 0 1 1 7.5 6.572" />
        </svg>
      </button>
    </form>
    {% else %}
    <a href="{% url 'accounts:login' %}?next={{ request.path }}" class="cursor-pointer transition-colors hover:text-red-500">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" 
        fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        class="icon icon-tabler icons-tabler-outline icon-tabler-heart">
        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
        <path d="M19.5 12.572l-7.5 7.428l-7.5 -7.428a5 5 0 1 1 7.5 -6.566a5 5 0 1 1 7.5 6.572" />
      </svg>
    </a>
    {% endif %}
  </div>

  <!-- Product Title-->
  <a href="{{ product.get_absolute_url }}">
    <h2 class="hover:text-primary-900 mb-3 cursor-pointer text-sm leading-6 font-semibold transition-colors md:text-base line-clamp-2">
      {{ product.name }}
    </h2>
  </a>

  <!-- Price & Add to Cart -->
  <div class="bottom-0 flex items-center justify-between">
    <!-- Add to Cart Button -->
    <div>
      {% if product.is_in_stock %}
      <form action="{% url 'cart:add' product.id %}" method="POST" class="inline">
        {% csrf_token %}
        <input type="hidden" name="quantity" value="1">
        <button type="submit"
          class="bg-primary-800 hover:bg-primary-900 flex items-center justify-center gap-x-2 rounded-lg px-3 py-2 text-xs md:text-sm font-semibold text-white transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="icon icon-tabler icons-tabler-outline icon-tabler-shopping-cart-plus">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M4 19a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
            <path d="M12.5 17h-6.5v-14h-2" />
            <path d="M6 5l14 1l-.86 6.017m-2.64 .983h-10.5" />
            <path d="M16 19h6" />
            <path d="M19 16v6" />
          </svg>
          <span class="hidden sm:inline">افزودن به سبد</span>
        </button>
      </form>
      {% else %}
      <span class="text-sm text-red-500 font-semibold">ناموجود</span>
      {% endif %}
    </div>

    <!-- Price -->
    <div class="flex flex-col items-end">
      {% if product.compare_at_price and product.compare_at_price > product.price %}
      <span class="text-xs text-gray-400 line-through">{{ product.compare_at_price|intcomma }} تومان</span>
      <span class="text-sm font-bold text-primary-800">{{ product.price|intcomma }} تومان</span>
      {% else %}
      <span class="text-sm font-bold text-gray-800">{{ product.price|intcomma }} تومان</span>
      {% endif %}
    </div>
  </div>
</div>
